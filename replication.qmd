---
title: 'Replicating The Log of Gravity'
author1: "Mauricio Vargas Sep√∫lveda (ORCID 0000-0003-1017-7574)"
email1: m.sepulveda@mail.utoronto.ca
affiliation11: Department of Political Science, University of Toronto
affiliation12: Munk School of Global Affairs and Public Policy, University of Toronto
format:
  pdf:
    pdf-engine: pdflatex
    template: "template.tex"
    keep-tex: true
    post-process: "move_pdf.sh"
bibliography: references.bib
csl: chicago.csl
fontsize: 12pt
linespacing: 1.5
margin: 1
paper: letterpaper
customfonts: false
sansserif: false
amsthm: false
outline: true
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = TRUE)
```

# Abstract

This document replicates the main results from @silva2006log in R. The original
results were obtained in TSP back in 2006. The idea here is to be explicit
regarding the conceptual approach to regression in R. For most of the
replication I used base R without external libraries except when it was
absolutely necessary. The findings are consistent with the original article and
reveal that the replication effort is minimal, without the need to contact the
authors for clarifications or incur into data transformations or filtering not
mentioned in the article.

# Introduction

@silva2006log used [TSP](https://en.wikipedia.org/wiki/TSP_(econometrics_software))
back in 2006 to estimate different functional forms of the gravity model
of trade. The article is a classic in the field of international trade and
has been cited over 8,500 times according to Google Scholar. Its contribution,
which was a new Poisson-based estimator to correct the bias in the Ordinary
Least Squares (OLS) estimator under heteroskedasticity, has been widely used in
the academic literature. Besides pure academic interests, the OLS estimator bias
has implications for policy analysis, and posterior works with clear insights
for International Relations academics and Public Policy practitioners, including
@head_chapter_2014, @yotov_advanced_2016, and @felbermayr_global_2020.

Outside of statistical concerns about biases, the field of International
Relations has developed interesting critiques about leaving theory behind.
@mearsheimer_leaving_2013 argues that the field has been dominated by
quantitative studies that present simplistic hypothesis after incentives to
present academic findings as more interesting for policymakers. From this
critique, @silva2006log is relevant not only for its methodological contribution
and presenting an estimator that can largely differ from OLS, but also for
presenting an estimator that is consistent with micro-founded approaches to
the gravity model of trade, including @eaton_technology_2001.

The goal in this document is to be explicit regarding the conceptual approach to
regression in R. For most of the replication we used base R [@core2021base] and
relying on external libraries (e.g., R packages) when it was absolutely
necessary based on the criteria that implementing methods such as the Tobit
estimator from scratch would be time consuming and would deviate from the
replication effort. The results are consistent with the gravity package
[@woelwer2020gravity] which provides convenient wrappers for gravity estimation,
but the idea was to be explicit about the steps involved in the replication
process and using wrappers would have made the steps less clear.

# Original codes and data

We organized the original codes and data from the authors' site,
[The Log of Gravity](https://personal.lse.ac.uk/tenreyro/lgw.html), on
[GitHub](https://github.com/pachadotdev/log-of-gravity) and therefore ease
replication in the event that the links change in the future.

We obtained the original data and code with the following R code:

```{r download}
url <- "https://personal.lse.ac.uk/tenreyro/regressors.zip"
zip <- gsub(".*/", "", url)
if (!file.exists(zip)) try(download.file(url, zip))

dout <- "regressors"
if (!dir.exists(dout)) unzip(zip, exdir = dout)
```

The original dataset obtained in the previous step is available in Stata
format, a closed source format that we can read in R thanks to the haven package
[@wickham2021haven] without loss of information or other common problems when
reading proprietary formats.

We proceeded to import R packages to ease our work and read the data with the
following R code:

```{r import}
library(haven) # read Stata datasets
library(censReg) # Tobit estimation
library(stargazer) # table of results

log_of_gravity <- read_dta(paste0(dout, "/Log of Gravity.dta"))
```

# Models replication

## Poisson Pseudo Maximum Likelihood

Table 3 in @silva2006log summarises a large portion of the article. Starting
from the Poisson Pseudo Maximum Likelihood (PPML) estimation, we can replicate
the results with the Generalized Linear Model (GLM) and a quasi-Poisson link in
R. The original article estimates the model with and without zero flows.

We could replicate the PPML model results with and without zero flows with the
following R code:

```{r replication}
ppml_formula <- trade ~ lypex + lypim + lyex + lyim + ldist + border +
  comlang + colony + landl_ex + landl_im + lremot_ex + lremot_im +
  comfrt_wto + open_wto

fit_ppml_1 <- glm(
  ppml_formula,
  data = log_of_gravity,
  subset = trade > 0,
  family = quasipoisson()
)

fit_ppml_2 <- glm(
  ppml_formula,
  data = log_of_gravity,
  family = quasipoisson()
)
```

The replication effort for the PPML model was minimal, it was sufficient to look
at the summary table in the article and subset the data to drop zero flows. This
step did not require to guess data cleaning steps or transformations not
mentioned in the article.

## Ordinary Least Squares

The only consideration for the OLS model was to drop zero flows for some of the
models with log in the dependent variable even when Table 3 is not explicit
about this, otherwise we break the fitting algorithm (e.g. because
$\log(0) \to -\infty$).

For estimations of the form
$\log(\text{trade}) = \beta_0 + \beta_1 \text{lypex} + \dots + \varepsilon,$
we needed to drop zero flows to replicate the result. On the other hand, 
for estimations of the type 
$\log(1 + \text{trade}) = \beta_0 + \beta_1 \text{lypex} + \dots + \varepsilon,$
we did not need to drop zero flows.

```{r replication2}
fit_ols_1 <- lm(
  update.formula(ppml_formula, log(.) ~ .),
  data = log_of_gravity,
  subset = trade > 0
)

fit_ols_2 <- lm(
  update.formula(ppml_formula, log(1 + .) ~ .),
  data = log_of_gravity
)
```

## Tobit

The Tobit estimation required the use of the censReg package
[@henningsen2020censreg]. Unlike PPML and OLS models, this required us to
extract the right hand side of the model formula to define a vector of zeroes 
with a length equal to the independent variables plus two as starting point for
the Maximum Likelihood estimation (e.g., counting the depending variable and 
intercept besides the estimating slopes).

In order to obtain the $a$ parameter that matches the results in the article we
proceeded with an iteration loop until achieving convergence with respect to
one of the estimated slopes. The initial value of $a=200$ was arbitrary and
set after trying reasonable guesses that converge to the slopes in the original
article after 9 iterations for a final value of $a=159$.

```{r replication3}
a <- 200
lypex_ref <- 1.058
tol <- 0.001
lypex_estimate <- 2 * lypex_ref
iter <- 0

while (abs(lypex_estimate - lypex_ref) > tol) {
  log_of_gravity$log_trade_cens <- log(a + log_of_gravity$trade)
  log_trade_cens_min <- min(log_of_gravity$log_trade_cens, na.rm = TRUE)

  fit_tobit <- censReg(
    formula = update.formula(ppml_formula, log_trade_cens ~ .),
    left = log_trade_cens_min,
    right = Inf,
    data = log_of_gravity,
    start = rep(0, 2 + length(attr(terms(ppml_formula), "term.labels"))),
    method = "BHHH"
  )

  lypex_estimate <- coef(fit_tobit)[2]
  if (abs(lypex_estimate - lypex_ref) > 2 * tol) {
    a <- a - 5
  } else {
    a <- a - 1
  }
  iter <- iter + 1
}
```

## Non-Linear Least Squares

The starting values were retrieved from the PPML model results with zero flows
and then passed to the GLM function with a Gaussian log-link in R.

```{r replication4}
fit_ppml_eta <- fit_ppml_2$linear.predictors
fit_ppml_mu <- fit_ppml_2$fitted.values
fit_ppml_start <- fit_ppml_2$coefficients

fit_nls <- glm(
  ppml_formula,
  data = log_of_gravity,
  family = gaussian(link = "log"),
  etastart = fit_ppml_eta,
  mustart = fit_ppml_mu,
  start = fit_ppml_start,
  control = list(maxit = 200, trace = FALSE)
)
```

# Replication results

@silva2006log is very close to full replication according to the criteria
defined in @peng2011reproducible. The replication results are consistent with
the original article and reveal equivalent figures for all the models estimated
in the original article.

The results are presented in the following table:

```{r replication5, results='asis'}
stargazer(
  fit_ols_1, fit_ols_2, fit_tobit, fit_nls, fit_ppml_1, fit_ppml_2,
  header = FALSE, font.size = "footnotesize", model.names = F,
  omit.table.layout = "d", omit.stat = c(
    "f", "ser", "ll", "aic", "bic", "rsq", "adj.rsq"
  ),
  title = "Replication results for OLS (1-2), Tobit (3), NLS (4) and
  PPML (5-6)."
)
```

\newpage

# Conclusion

The replication effort was minimal, without the need to contact the authors for
clarifications or incur into data transformations or filtering not mentioned in
the article. The results are consistent with the original article and reveal
proper and transparent scholarship. Ideally, all disciplines that rely on
quantitative research and the use of statistical methods to test hypotheses
should follow similar or higher standards of transparency, but that is not
always the case as initiatives such as @simonsohn_data_2024 reveal.

# Acknowledgements

Thanks to Joao Santos Silva for pointing that out, in a previous version of this
document I mentioned that the original results were obtained with Stata.

# References
